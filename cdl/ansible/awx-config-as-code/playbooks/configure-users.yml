---
- name: Configure AWX Users
  hosts: localhost
  connection: local
  gather_facts: false
  
  vars_files:
    - ../vars/users.yml
  
  tasks:
    - name: Display AWX connection info
      ansible.builtin.debug:
        msg: "Connecting to AWX at {{ controller_host | default(lookup('env', 'CONTROLLER_HOST')) }}"

    - name: Ensure organizations exist
      awx.awx.organization:
        name: "{{ item.name }}"
        description: "{{ item.description }}"
        state: present
        controller_host: "{{ controller_host | default(lookup('env', 'CONTROLLER_HOST')) }}"
        controller_username: "{{ controller_username | default(lookup('env', 'CONTROLLER_USERNAME')) }}"
        controller_password: "{{ controller_password | default(lookup('env', 'CONTROLLER_PASSWORD')) }}"
        validate_certs: false
      loop: "{{ awx_organizations }}"
      loop_control:
        label: "{{ item.name }}"
      tags:
        - organizations

    - name: Create AWX users
      awx.awx.user:
        username: "{{ item.username }}"
        email: "{{ item.email }}"
        first_name: "{{ item.first_name }}"
        last_name: "{{ item.last_name }}"
        password: "{{ item.password }}"
        superuser: "{{ item.is_superuser | default(false) }}"
        auditor: "{{ item.is_system_auditor | default(false) }}"
        state: present
        controller_host: "{{ controller_host | default(lookup('env', 'CONTROLLER_HOST')) }}"
        controller_username: "{{ controller_username | default(lookup('env', 'CONTROLLER_USERNAME')) }}"
        controller_password: "{{ controller_password | default(lookup('env', 'CONTROLLER_PASSWORD')) }}"
        validate_certs: false
      loop: "{{ awx_users }}"
      loop_control:
        label: "{{ item.username }}"
      tags:
        - users

    - name: Assign user roles to organizations
      awx.awx.role:
        user: "{{ item.username }}"
        organization: "{{ item.organization }}"
        role: "{{ item.role }}"
        state: present
        controller_host: "{{ controller_host | default(lookup('env', 'CONTROLLER_HOST')) }}"
        controller_username: "{{ controller_username | default(lookup('env', 'CONTROLLER_USERNAME')) }}"
        controller_password: "{{ controller_password | default(lookup('env', 'CONTROLLER_PASSWORD')) }}"
        validate_certs: false
      loop: "{{ user_roles }}"
      loop_control:
        label: "{{ item.username }} -> {{ item.organization }} ({{ item.role }})"
      tags:
        - roles

    - name: Display created users
      ansible.builtin.debug:
        msg: "Successfully configured {{ awx_users | length }} users"
