---
- name: Configure AWX Credentials
  hosts: localhost
  connection: local
  gather_facts: false
  
  vars_files:
    - ../vars/credentials.yml
  
  tasks:
    - name: Display AWX connection info
      ansible.builtin.debug:
        msg: "Connecting to AWX at {{ controller_host | default(lookup('env', 'CONTROLLER_HOST')) }}"

    - name: Create AWX Credentials
      awx.awx.credential:
        name: "{{ item.name }}"
        description: "{{ item.description }}"
        organization: "{{ item.organization }}"
        credential_type: "{{ item.credential_type }}"
        inputs: "{{ item.inputs }}"
        state: present
        controller_host: "{{ controller_host | default(lookup('env', 'CONTROLLER_HOST')) }}"
        controller_username: "{{ controller_username | default(lookup('env', 'CONTROLLER_USERNAME')) }}"
        controller_password: "{{ controller_password | default(lookup('env', 'CONTROLLER_PASSWORD')) }}"
        validate_certs: false
      loop: "{{ awx_credentials }}"
      loop_control:
        label: "{{ item.name }}"
      tags:
        - credentials

    - name: Summary of created credentials
      ansible.builtin.debug:
        msg:
          - "Successfully configured AWX Credentials:"
          - "  Total Credentials: {{ awx_credentials | length }}"
          - "  Credential Names: {{ awx_credentials | map(attribute='name') | list }}"
      tags:
        - always
